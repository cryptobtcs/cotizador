<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Cotizaciones</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h1>Generador de Cotizaciones</h1>

  <label for="cliente">Cliente:</label>
  <input type="text" id="cliente"><br>

  <label for="fecha">Fecha:</label>
  <input type="date" id="fecha"><br><br>

  <label for="descripcion">Descripción:</label>
  <input type="text" id="descripcion" size="60"><br>

  <label for="cantidad">Cantidad:</label>
  <input type="number" id="cantidad"><br>

  <label for="unidad">Unidad:</label>
  <input type="text" id="unidad"><br>

  <label for="precio">Precio:</label>
  <input type="number" id="precio" step="0.01"><br><br>

  <button onclick="agregarProducto()">Agregar producto</button>
  <button onclick="generarPDF()">Generar PDF</button>

  <script>
    let productos = [];
    let folio = parseInt(localStorage.getItem("folio") || "1");

    function agregarProducto() {
      const descripcion = document.getElementById("descripcion").value;
      const cantidad = parseFloat(document.getElementById("cantidad").value);
      const unidad = document.getElementById("unidad").value;
      const precio = parseFloat(document.getElementById("precio").value);
      const subtotal = cantidad * precio;

      productos.push({ descripcion, cantidad, unidad, precio, subtotal });

      // Limpiar campos
      document.getElementById("descripcion").value = "";
      document.getElementById("cantidad").value = "";
      document.getElementById("unidad").value = "";
      document.getElementById("precio").value = "";
    }

    function breakText(text, font, size, maxWidth) {
      const words = text.split(" ");
      let lines = [];
      let line = "";

      for (let word of words) {
        let testLine = line + word + " ";
        let width = font.widthOfTextAtSize(testLine, size);
        if (width > maxWidth) {
          lines.push(line.trim());
          line = word + " ";
        } else {
          line = testLine;
        }
      }
      if (line) lines.push(line.trim());
      return lines;
    }

    async function generarPDF() {
      const cliente = document.getElementById("cliente").value;
      const fecha = document.getElementById("fecha").value;

      if (!cliente || !fecha || productos.length === 0) {
        alert("Completa los datos del cliente y al menos un producto.");
        return;
      }

      const pdfDoc = await PDFLib.PDFDocument.create();
      let page = pdfDoc.addPage([595, 842]);
      const { width, height } = page.getSize();
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
      const fontBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

      let y = height - 50;
      const fontSize = 12;

      page.drawText(`Cotización - Folio: ${folio.toString().padStart(4, '0')}`, {
        x: 50,
        y,
        size: 16,
        font: fontBold,
      });

      y -= 30;

      // Tabla de cliente y fecha
      const tableX = 50;
      const tableW = 500;
      const rowH = 25;

      page.drawRectangle({ x: tableX, y: y - rowH * 2, width: tableW, height: rowH * 2, borderColor: PDFLib.rgb(0, 0, 0), borderWidth: 1 });

      page.drawText("Cliente:", { x: tableX + 5, y: y - 18, size: fontSize, font: fontBold });
      page.drawText(cliente, { x: tableX + 70, y: y - 18, size: fontSize, font });

      page.drawText("Fecha:", { x: tableX + 5, y: y - 18 - rowH, size: fontSize, font: fontBold });
      page.drawText(fecha, { x: tableX + 70, y: y - 18 - rowH, size: fontSize, font });

      y -= rowH * 2 + 20;

      // Encabezados
      const cols = [
        { name: "Descripción", width: 250 },
        { name: "Cantidad", width: 60 },
        { name: "Unidad", width: 60 },
        { name: "Precio", width: 80 },
        { name: "Subtotal", width: 80 },
      ];

      const tableStartY = y;
      let currentY = y;

      // Dibujar encabezados
      let x = tableX;
      for (let col of cols) {
        page.drawRectangle({ x, y: currentY - 20, width: col.width, height: 20, borderColor: PDFLib.rgb(0, 0, 0), borderWidth: 1 });
        page.drawText(col.name, { x: x + 2, y: currentY - 15, size: fontSize - 1, font: fontBold });
        x += col.width;
      }

      currentY -= 20;

      for (let p of productos) {
        const descLines = breakText(p.descripcion, font, fontSize - 1, cols[0].width - 4);
        const linesNeeded = descLines.length;
        const rowHeight = 15 * linesNeeded;

        // Si no hay espacio para otra fila + total, nueva página
        if (currentY - rowHeight < 100) {
          page = pdfDoc.addPage([595, 842]);
          currentY = height - 50;

          x = tableX;
          for (let col of cols) {
            page.drawRectangle({ x, y: currentY - 20, width: col.width, height: 20, borderColor: PDFLib.rgb(0, 0, 0), borderWidth: 1 });
            page.drawText(col.name, { x: x + 2, y: currentY - 15, size: fontSize - 1, font: fontBold });
            x += col.width;
          }

          currentY -= 20;
        }

        x = tableX;
        for (let i = 0; i < cols.length; i++) {
          page.drawRectangle({ x, y: currentY - rowHeight, width: cols[i].width, height: rowHeight, borderColor: PDFLib.rgb(0, 0, 0), borderWidth: 1 });
          x += cols[i].width;
        }

        let textY = currentY - 12;
        for (let line of descLines) {
          page.drawText(line, { x: tableX + 2, y: textY, size: fontSize - 1, font });
          textY -= 15;
        }

        page.drawText(p.cantidad.toString(), { x: tableX + cols[0].width + 2, y: currentY - 12, size: fontSize - 1, font });
        page.drawText(p.unidad, { x: tableX + cols[0].width + cols[1].width + 2, y: currentY - 12, size: fontSize - 1, font });
        page.drawText(`$${p.precio.toFixed(2)}`, { x: tableX + cols[0].width + cols[1].width + cols[2].width + 2, y: currentY - 12, size: fontSize - 1, font });
        page.drawText(`$${p.subtotal.toFixed(2)}`, { x: tableX + cols[0].width + cols[1].width + cols[2].width + cols[3].width + 2, y: currentY - 12, size: fontSize - 1, font });

        currentY -= rowHeight;
      }

      const total = productos.reduce((sum, p) => sum + p.subtotal, 0);
      currentY -= 20;

      if (currentY < 100) {
        page = pdfDoc.addPage([595, 842]);
        currentY = height - 50;
      }

      page.drawText(`TOTAL: $${total.toFixed(2)}`, {
        x: width - 200,
        y: currentY,
        size: fontSize + 1,
        font: fontBold,
      });

      currentY -= 30;

      page.drawText("Una vez pagada la cotización, se da por aceptado el producto o servicio.", {
        x: 50,
        y: currentY,
        size: fontSize - 1,
        font,
      });

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      saveAs(blob, `cotizacion_${folio.toString().padStart(4, '0')}.pdf`);

      folio++;
      localStorage.setItem("folio", folio);
    }
  </script>
</body>
</html>

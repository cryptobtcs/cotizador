<script>
  async function generarPDF() {
    const cliente = document.getElementById("cliente").value;
    const fecha = document.getElementById("fecha").value;

    if (!cliente || !fecha || productos.length === 0) {
      alert("Faltan datos");
      return;
    }

    const url = "plantilla.pdf"; // Asegúrate de que este archivo esté en la misma carpeta que tu HTML

    try {
      const existingPdfBytes = await fetch(url).then(res => {
        if (!res.ok) throw new Error("No se pudo cargar la plantilla PDF");
        return res.arrayBuffer();
      });

      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
      const page = pdfDoc.getPages()[0];
      const { width, height } = page.getSize();
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
      const fontSize = 10;
      const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold); // Fuente en negrita

      // Ajustando la posición para mover todo 3 líneas más abajo
      const startY = height - 100;

      // Folio
      page.drawText(`Folio: ${folio.toString().padStart(4, '0')}`, {
        x: 50,
        y: startY,
        size: fontSize,
        font: boldFont,
        color: PDFLib.rgb(1, 0, 0) // Color rojo
      });

      // Cliente
      page.drawText("Cliente:", {
        x: 50,
        y: startY - 20,
        size: fontSize,
        font: boldFont
      });
      page.drawText(cliente, {
        x: 120,
        y: startY - 20,
        size: fontSize,
        font: font
      });

      // Fecha
      page.drawText("Fecha:", {
        x: 50,
        y: startY - 40,
        size: fontSize,
        font: boldFont
      });
      page.drawText(fecha, {
        x: 120,
        y: startY - 40,
        size: fontSize,
        font: font
      });

      // Leyenda
      page.drawText("Una vez pagada la cotización, se da por aceptado de conformidad el producto o servicio.", {
        x: 50,
        y: startY - 60,
        size: fontSize,
        font: font,
        maxWidth: 500
      });

      // Tabla de productos
      let tableStartY = startY - 90; // Empieza la tabla un poco más abajo
      const tableHeaders = ["Descripción", "Cantidad", "Unidad", "Precio", "Subtotal"];
      const cellPadding = 5;

      // Dibuja encabezados
      const headerXPositions = [50, 250, 300, 380, 460]; // Posiciones horizontales de las celdas
      tableHeaders.forEach((header, i) => {
        page.drawText(header, {
          x: headerXPositions[i],
          y: tableStartY,
          size: fontSize,
          font: boldFont
        });
      });

      tableStartY -= 20; // Espacio debajo del encabezado

      // Dibuja las filas de productos
      for (const p of productos) {
        if (tableStartY < 100) break; // Evita escribir sobre el pie del PDF

        page.drawText(p.descripcion, { x: 50, y: tableStartY, size: fontSize, font: font });
        page.drawText(p.cantidad.toString(), { x: 250, y: tableStartY, size: fontSize, font: font });
        page.drawText(p.unidad, { x: 300, y: tableStartY, size: fontSize, font: font });
        page.drawText(`$${p.precio.toFixed(2)}`, { x: 380, y: tableStartY, size: fontSize, font: font });
        page.drawText(`$${p.subtotal.toFixed(2)}`, { x: 460, y: tableStartY, size: fontSize, font: font });

        tableStartY -= 18; // Espaciado entre filas
      }

      // Total
      const total = productos.reduce((sum, p) => sum + p.subtotal, 0);
      page.drawText(`TOTAL: $${total.toFixed(2)}`, {
        x: 400,
        y: tableStartY - 20,
        size: fontSize + 1,
        font: boldFont
      });

      // Pregunta si lleva IVA
      const iva = confirm("¿La cotización incluye IVA?");
      if (iva) {
        const ivaAmount = total * 0.16; // Calcula el IVA
        page.drawText(`IVA (16%): $${ivaAmount.toFixed(2)}`, {
          x: 400,
          y: tableStartY - 40,
          size: fontSize,
          font: font
        });
        page.drawText(`TOTAL CON IVA: $${(total + ivaAmount).toFixed(2)}`, {
          x: 400,
          y: tableStartY - 60,
          size: fontSize + 1,
          font: boldFont
        });
      }

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      saveAs(blob, `cotizacion_${folio.toString().padStart(4, '0')}.pdf`);

      folio++;
      localStorage.setItem("folio", folio);
    } catch (error) {
      alert("Error al generar PDF: " + error.message);
      console.error(error);
    }
  }
</script>
